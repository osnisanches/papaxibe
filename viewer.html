<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guia Papa Xib√© - COP30</title>
    <style>
        /* ESTILOS ESSENCIAIS */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body, html {
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        
        /* CONTAINER PRINCIPAL */
        .viewer-container {
            width: 100%;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            background: #f5f5f5;
            overflow: auto;
            display: none;
        }
        
        /* VIEWER DO PDF */
        #viewer {
            width: 100%;
            padding: 0;
        }
        
        /* P√ÅGINAS DO PDF - ESPA√áAMENTO DE 1px */
        .pdfViewer .page {
            margin: 1px auto !important;
            border: none;
            box-shadow: none;
            position: relative;
        }
        
        .pdfViewer .canvasWrapper {
            text-align: center;
            margin: 0 !important;
            padding: 0 !important;
        }
        
        .pdfViewer .page canvas {
            max-width: 100%;
            height: auto;
            display: block;
        }
        
        /* CAMADA DE TEXTO (OCULTA) */
        .textLayer {
            display: none !important;
            opacity: 0 !important;
            visibility: hidden !important;
        }
        
        /* CAMADA DE ANOTA√á√ïES - CR√çTICO PARA LINKS */
        .annotationLayer {
            display: block !important;
            opacity: 1 !important;
            visibility: visible !important;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: auto;
        }
        
        .annotationLayer section {
            position: absolute;
        }
        
        .annotationLayer a {
            display: block;
            position: absolute;
            background: transparent;
            cursor: pointer;
        }
        
        /* LOADING */
        .loading-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4a7c59;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            color: #4a7c59;
            font-size: 16px;
            margin-bottom: 8px;
        }
        
        .loading-subtext {
            color: #666;
            font-size: 14px;
        }
        
        /* ERRO */
        .error-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
            text-align: center;
        }
        
        .error-icon {
            font-size: 40px;
            margin-bottom: 15px;
        }
        
        .error-title {
            color: #d32f2f;
            font-size: 18px;
            margin-bottom: 10px;
        }
        
        .error-message {
            color: #666;
            font-size: 14px;
            margin-bottom: 20px;
            max-width: 350px;
            line-height: 1.4;
        }
        
        .error-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .error-button {
            background: #4a7c59;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .error-button.secondary {
            background: #6c757d;
        }
        
        /* BOT√ÉO FLUTUANTE */
        .floating-badge {
            position: fixed;
            bottom: 15px;
            right: 15px;
            background: #4a7c59;
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1001;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .flag-small {
            width: 20px;
            height: 15px;
            border-radius: 2px;
        }
        
        .separator {
            width: 1px;
            height: 16px;
            background: rgba(255,255,255,0.3);
        }
    </style>
</head>
<body>
    <!-- Loading -->
    <div id="loadingContainer" class="loading-container">
        <div class="loading-spinner"></div>
        <div class="loading-text">Carregando Guia...</div>
        <div class="loading-subtext" id="loadingSubtext">Aguarde um momento</div>
    </div>

    <!-- Erro -->
    <div id="errorContainer" class="error-container">
        <div class="error-icon">‚ùå</div>
        <div class="error-title">Erro ao Carregar PDF</div>
        <div class="error-message" id="errorMessage">
            N√£o foi poss√≠vel carregar o guia. Verifique sua conex√£o e tente novamente.
        </div>
        <div class="error-buttons">
            <button class="error-button" onclick="retryLoadPDF()">üîÑ Tentar Novamente</button>
            <button class="error-button secondary" onclick="downloadPDFDirect()">üì• Fazer Download</button>
        </div>
    </div>

    <!-- Bot√£o flutuante -->
    <div class="floating-badge" onclick="goBack()">
        <img src="" alt="Voltar" class="flag-small" id="flagIcon">
        <div class="separator"></div>
        <div onclick="downloadPDFDirect(); event.stopPropagation();">‚¨áÔ∏è</div>
    </div>
    
    <!-- Viewer do PDF -->
    <div id="viewerContainer" class="viewer-container">
        <div id="viewer" class="pdfViewer"></div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
    <script src="https://unpkg.com/pdfjs-dist@3.11.174/web/pdf_viewer.js"></script>
    
    <script>
        // Configura√ß√µes
        const CONFIG = {
            pdfs: {
                'pt': { path: 'pdf/guia-pt.pdf', name: 'Guia_Papa_Xibe_Portugues.pdf', flag: 'https://flagcdn.com/w40/br.png' },
                'en': { path: 'pdf/guia-en.pdf', name: 'Guia_Papa_Xibe_English.pdf', flag: 'https://flagcdn.com/w40/us.png' },
                'es': { path: 'pdf/guia-es.pdf', name: 'Guia_Papa_Xibe_Espanol.pdf', flag: 'https://flagcdn.com/w40/es.png' }
            }
        };

        // Estado da aplica√ß√£o
        let pdfViewer = null;
        let pdfLinkService = null;
        let isFirstPageRendered = false;

        // Inicializa√ß√£o
        function init() {
            const lang = getLanguageFromURL();
            document.getElementById('flagIcon').src = CONFIG.pdfs[lang].flag;
            loadPDF(lang);
        }

        function getLanguageFromURL() {
            const params = new URLSearchParams(window.location.search);
            return params.get('lang') || 'pt';
        }

        function loadPDF(lang) {
            showLoading();
            
            // Configura√ß√£o do PDF.js
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.worker.min.js';
            
            const pdfPath = CONFIG.pdfs[lang].path;
            let loadTimeout = setTimeout(() => {
                showError('O carregamento est√° demorando mais que o normal.');
            }, 10000);

            // Carrega o documento PDF
            pdfjsLib.getDocument(pdfPath).promise
                .then(pdfDoc => {
                    clearTimeout(loadTimeout);
                    setupPDFViewer(pdfDoc, lang);
                })
                .catch(error => {
                    clearTimeout(loadTimeout);
                    handleLoadError(error);
                });
        }

        function setupPDFViewer(pdfDoc, lang) {
            const eventBus = new pdfjsViewer.EventBus();
            const container = document.getElementById('viewerContainer');
            
            // Configura√ß√£o completa para interatividade
            pdfLinkService = new pdfjsViewer.PDFLinkService({
                eventBus: eventBus
            });
            
            const pdfFindController = new pdfjsViewer.PDFFindController({
                eventBus: eventBus,
                linkService: pdfLinkService
            });
            
            pdfViewer = new pdfjsViewer.PDFViewer({
                container: container,
                eventBus: eventBus,
                linkService: pdfLinkService,
                findController: pdfFindController,
                removePageBorders: true,
                textLayerMode: 0, // DESABILITA camada de texto
                annotationMode: 2 // HABILITA camada de anota√ß√µes
            });
            
            pdfLinkService.setViewer(pdfViewer);
            pdfViewer.setDocument(pdfDoc);
            pdfLinkService.setDocument(pdfDoc, null);
            
            // MOSTRA O PDF IMEDIATAMENTE AP√ìS A PRIMEIRA P√ÅGINA
            eventBus.on('page rendering', (e) => {
                if (!isFirstPageRendered) {
                    isFirstPageRendered = true;
                    
                    // Ajusta a escala
                    const firstPage = pdfViewer.getPageView(0);
                    if (firstPage) {
                        const scale = Math.min(
                            (window.innerWidth - 20) / firstPage.width,
                            (window.innerHeight - 20) / firstPage.height,
                            1.5
                        );
                        pdfViewer.currentScale = scale;
                    }
                    
                    // MOSTRA O VIEWER IMEDIATAMENTE
                    showPDF();
                    updateLoadingText('Carregando p√°ginas restantes...');
                }
            });
            
            // Garante que as anota√ß√µes fiquem vis√≠veis
            eventBus.on('pagerendered', (e) => {
                const pageElement = e.source.div;
                
                // Remove completamente a camada de texto se existir
                const textLayer = pageElement.querySelector('.textLayer');
                if (textLayer) {
                    textLayer.remove();
                }
                
                // Garante que a camada de anota√ß√µes est√° vis√≠vel e funcional
                const annotationLayer = pageElement.querySelector('.annotationLayer');
                if (annotationLayer) {
                    annotationLayer.style.display = 'block';
                    annotationLayer.style.opacity = '1';
                    annotationLayer.style.pointerEvents = 'auto';
                }
            });
            
            // Fallback: se ap√≥s 3 segundos a primeira p√°gina n√£o renderizou
            setTimeout(() => {
                if (!isFirstPageRendered) {
                    isFirstPageRendered = true;
                    showPDF();
                }
            }, 3000);
            
            // Redimensionamento
            window.addEventListener('resize', debounce(() => {
                if (pdfViewer && pdfViewer.getPageView(0)) {
                    const firstPage = pdfViewer.getPageView(0);
                    const scale = Math.min(
                        (window.innerWidth - 20) / firstPage.width,
                        (window.innerHeight - 20) / firstPage.height,
                        1.5
                    );
                    pdfViewer.currentScale = scale;
                }
            }, 250));
        }

        function showLoading() {
            document.getElementById('loadingContainer').style.display = 'flex';
            document.getElementById('errorContainer').style.display = 'none';
            document.getElementById('viewerContainer').style.display = 'none';
        }

        function showError(message) {
            document.getElementById('loadingContainer').style.display = 'none';
            document.getElementById('errorContainer').style.display = 'flex';
            document.getElementById('viewerContainer').style.display = 'none';
            
            if (message) {
                document.getElementById('errorMessage').textContent = message;
            }
        }

        function showPDF() {
            document.getElementById('loadingContainer').style.display = 'none';
            document.getElementById('errorContainer').style.display = 'none';
            document.getElementById('viewerContainer').style.display = 'block';
            
            // Limpeza final de qualquer texto residual
            setTimeout(() => {
                document.querySelectorAll('.textLayer').forEach(layer => {
                    layer.remove();
                });
            }, 100);
        }

        function updateLoadingText(text) {
            document.getElementById('loadingSubtext').textContent = text;
        }

        function handleLoadError(error) {
            console.error('Erro ao carregar PDF:', error);
            
            let message = 'Erro ao carregar o PDF. ';
            if (error.name === 'MissingPDFException') {
                message += 'Arquivo n√£o encontrado.';
            } else if (error.name === 'InvalidPDFException') {
                message += 'Arquivo PDF inv√°lido.';
            } else if (error.message && error.message.includes('NetworkError')) {
                message += 'Problema de conex√£o.';
            }
            
            showError(message);
        }

        function retryLoadPDF() {
            const lang = getLanguageFromURL();
            isFirstPageRendered = false;
            loadPDF(lang);
        }

        function downloadPDFDirect() {
            const lang = getLanguageFromURL();
            const pdfConfig = CONFIG.pdfs[lang];
            
            // Rastrear download no Google Analytics
            trackPDFDownload(lang);
            
            const link = document.createElement('a');
            link.href = pdfConfig.path;
            link.download = pdfConfig.name;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function trackPDFDownload(language) {
            if (typeof gtag !== 'undefined') {
                gtag('event', 'pdf_download', {
                    'event_category': 'download',
                    'event_label': `PDF_${language.toUpperCase()}`,
                    'value': 1
                });
            }
        }

        function goBack() {
            window.location.href = 'index.html';
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Inicializa quando o DOM estiver pronto
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
